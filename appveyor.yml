version: 1.0.{build}
image: Ubuntu2004
pull_requests:
    do_not_increment_build_number: true
branches:
    only:
        - main
environment:
    VERCEL_TOKEN:
        secure: InPNy6LbDQf4YYKZAVYpTbO0uRIKI6D3Dt+nHvOVvS8=
build: off
cache:
    - /var/lib/docker
    - /home/appveyor/.cache/yarn/v6
    - /home/appveyor/.nuget/packages
    - /home/appveyor/.npm
    - /home/appveyor/.yarn
    - /home/appveyor/.cargo
install:
    - nvm use 14
    - yarn global add vercel
    - if [[ -z "${VERCEL_TOKEN}" ]]; then yarn global add vercel;
    # - ps: if ($env:VERCEL_TOKEN) { yarn global add vercel && vercel -v }
    # - ps: export PATH="$(yarn global bin):$PATH"
    - vercel -v
    - pushd website
    - yarn
    - popd
build_script:
    - pushd bench
    - sudo dotnet run -c Release -p tool -- --task build --force-pull-docker true
    - sudo dotnet run -c Release -p tool -- --task test
    - sudo dotnet run -c Release -p tool -- --task bench
    - popd
    - pushd website
    - yarn
    - yarn content
    - yarn generate
    - popd
artifacts:
    - path: bench/build/_results
      name: benchmark_results
    - path: website/dist
      name: website
on_success:
    - if [[ -z "${VERCEL_TOKEN}" ]]; then vercel website --prod -c -C -t $VERCEL_TOKEN;
    # - ps: if ($env:VERCEL_TOKEN) { $a = vercel website --prod -c -C -t $env:VERCEL_TOKEN 2>&1 | out-null }
